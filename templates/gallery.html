{% extends "base.html" %}

{% block title %}Event Gallery - IT Department{% endblock %}

{% block content %}
<style>
    /* Force white background for the entire page body on gallery page */
    body {
        background-color: #FFFFFF !important;
    }

    .gallery-header {
        background: #FFFFFF !important;
        color: #800000 !important;
        padding: 3rem 0;
        margin: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
    }

    /* Masonry Grid Layout */
    .gallery-grid {
        column-count: 3;
        column-gap: 20px;
    }

    .page-header-bg {
        background: #FFFFFF !important;
        color: #800000 !important;
        padding: 130px 0 40px 0;
        border-radius: 0 !important;
        box-shadow: none !important;
        margin-bottom: 20px !important;
    }

    @media (max-width: 992px) {
        .gallery-grid {
            column-count: 2;
        }
    }

    @media (max-width: 576px) {
        .gallery-grid {
            column-count: 1;
        }
    }

    .gallery-item {
        break-inside: avoid;
        margin-bottom: 20px;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }

    .gallery-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px var(--card-shadow, rgba(0, 0, 0, 0.2)) !important;
    }

    .gallery-item img {
        width: 100%;
        height: auto;
        display: block;
        transition: transform 0.5s ease;
    }

    .gallery-item:hover img {
        transform: scale(1.05);
    }

    /* Overlay */
    .gallery-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
        padding: 60px 20px 20px 20px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gallery-item:hover .gallery-overlay {
        opacity: 1;
    }

    .gallery-overlay h6 {
        color: white;
        margin: 0;
        font-weight: 600;
    }

    .gallery-overlay small {
        color: rgba(255, 255, 255, 0.7);
    }

    /* Category Filter */
    .category-filter {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 30px;
    }

    .category-btn {
        background: #FFFFFF;
        border: 2px solid #e9ecef;
        color: #333;
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .category-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .category-btn.active {
        background: #800000;
        color: white;
        border-color: transparent;
    }

    /* Skeleton Loader */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 15px;
    }

    @keyframes shimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    /* Photo Counter */
    .photo-counter {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    /* Zoom Icon */
    .zoom-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        background: rgba(255, 255, 255, 0.9);
        color: #800000;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: transform 0.3s ease;
    }

    .gallery-item:hover .zoom-icon {
        transform: translate(-50%, -50%) scale(1);
    }
</style>

<header class="page-header-bg">
    <div class="container text-center position-relative z-2">
        <h1 class="display-4 fw-bold mb-2" data-aos="fade-down" style="color: #800000;">Event Gallery</h1>
        <p class="lead fw-bold" data-aos="fade-up" style="color: #800000; opacity: 0.8;">Capturing our department's best
            moments</p>
    </div>
</header>

<div class="container mb-5">
    <!-- Category Filter -->
    <div class="category-filter" data-aos="fade-up">
        <button class="category-btn active" data-category="all">
            <i class="bi bi-grid-3x3-gap me-1"></i> All Photos
        </button>
        <button class="category-btn" data-category="events">
            <i class="bi bi-calendar-event me-1"></i> Events
        </button>
        <button class="category-btn" data-category="workshops">
            <i class="bi bi-tools me-1"></i> Workshops
        </button>
        <button class="category-btn" data-category="celebrations">
            <i class="bi bi-balloon me-1"></i> Celebrations
        </button>
        <button class="category-btn" data-category="campus">
            <i class="bi bi-building me-1"></i> Campus
        </button>
    </div>

    <!-- Gallery Grid -->
    <div class="gallery-grid" id="galleryGrid">
        {% if photos %}
        {% for photo in photos %}
        <div class="gallery-item shadow" data-aos="zoom-in" data-aos-delay="{{ loop.index * 30 }}"
            data-category="{{ photo.caption.split()[0]|lower if photo.caption else 'events' }}" data-bs-toggle="modal"
            data-bs-target="#photoModal" data-src="{{ url_for('static', filename='uploads/' + photo.image_file) }}"
            data-caption="{{ photo.caption }}" data-index="{{ loop.index0 }}">

            <img src="{{ url_for('static', filename='uploads/' + photo.image_file) }}" alt="{{ photo.caption }}"
                loading="lazy" onload="this.parentElement.classList.add('loaded')">

            <div class="zoom-icon">
                <i class="bi bi-zoom-in"></i>
            </div>

            <div class="gallery-overlay">
                {% if photo.caption %}
                <h6>{{ photo.caption }}</h6>
                {% endif %}
                <small>{{ photo.upload_date }}</small>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-12 text-center py-5">
            <div class="p-5 rounded-3 shadow-sm border border-dashed" style="background: var(--card-bg);"
                data-aos="fade-up">
                <i class="bi bi-camera-fill fs-1 text-muted mb-3"></i>
                <h3 class="text-muted">No photos yet</h3>
                <p class="text-muted">New event photos will appear here soon.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Photo Count -->
    {% if photos %}
    <div class="text-center mt-4">
        <span class="badge bg-secondary rounded-pill px-4 py-2">
            <i class="bi bi-images me-2"></i><span id="photoCount">{{ photos|length }}</span> Photos
        </span>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // ========== CATEGORY FILTER ==========
    const categoryBtns = document.querySelectorAll('.category-btn');
    const galleryItems = document.querySelectorAll('.gallery-item');
    const photoCountEl = document.getElementById('photoCount');

    categoryBtns.forEach(btn => {
        btn.addEventListener('click', function () {
            categoryBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const category = this.getAttribute('data-category');
            let visibleCount = 0;

            galleryItems.forEach(item => {
                const itemCategory = item.getAttribute('data-category');

                if (category === 'all' || itemCategory === category || itemCategory.includes(category)) {
                    item.style.display = 'block';
                    item.style.animation = 'fadeInUp 0.4s ease forwards';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            if (photoCountEl) {
                photoCountEl.textContent = visibleCount;
            }
        });
    });

    // Animation keyframes
    const style = document.createElement('style');
    style.textContent = `
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;
    document.head.appendChild(style);

    // ========== ENHANCED MODAL ==========
    const galleryPhotos = [];
    document.querySelectorAll('.gallery-item').forEach((item, index) => {
        galleryPhotos.push({
            src: item.getAttribute('data-src'),
            caption: item.getAttribute('data-caption') || ''
        });
    });

    // Update the global gallery photos for navigation
    if (typeof window.galleryPhotos === 'undefined') {
        window.galleryPhotos = galleryPhotos;
    }

    // Lazy loading with Intersection Observer
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                    }
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '50px' });

        document.querySelectorAll('.gallery-item img[loading="lazy"]').forEach(img => {
            imageObserver.observe(img);
        });
    }
</script>
{% endblock %}